#!/usr/bin/env ruby
require File.expand_path('../../lib/rutt.rb', __FILE__)

RIP_ROOT = File.expand_path '~/Audio/rutt'
MP3_ROOT = File.expand_path '~/Audio/Lossy'
FLAC_ROOT= File.expand_path '~/Audio/Lossless'

cd = Cd.new(RIP_ROOT)

cd.fetch_metadata
cd.write_metadata_to_file
yaml_path = cd.yaml_path

# Open Editor for CD Info
system("/usr/bin/editor #{yaml_path}")
cd.reload_album_info_from_yaml
album = cd.album

cd.rip_to_wav

disc_path = cd.disc_path
wav_path = cd.wav_path

transcoder = Transcoder.new(album.songs)

tmp_mp3_path = "#{disc_path}/mp3"
transcoder.convert_all_wav_to_mp3(tmp_mp3_path)

#Add id3v2 tags
#Rename/Move Files
mp3_album_path = "#{MP3_ROOT}/#{album.dir_name}"
FileUtils.mkpath(mp3_album_path)


album.songs.each do |song|
    song.mp3 = "#{mp3_album_path}/#{song.generate_mp3_filename}"
    FileUtils.mv(song.tmp_mp3, song.mp3)
    song.apply_to_mp3 song.mp3
end


# Rip WAV to Flac
flac_path = "#{disc_path}/flac"
transcoder.convert_all_wav_to_flac(flac_path)

#Rename/Move Files
#Add metaflac tags
